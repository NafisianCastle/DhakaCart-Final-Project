name: Dependency Updates

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        directory: [frontend, backend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ${{ matrix.directory }}/package-lock.json

    - name: Install dependencies
      working-directory: ./${{ matrix.directory }}
      run: npm ci

    - name: Update dependencies
      working-directory: ./${{ matrix.directory }}
      run: |
        # Update patch and minor versions
        npm update
        
        # Check for major version updates
        npx npm-check-updates --target minor --upgrade
        
        # Install updated dependencies
        npm install

    - name: Run tests
      working-directory: ./${{ matrix.directory }}
      run: |
        if [ "${{ matrix.directory }}" = "frontend" ]; then
          npm test -- --coverage --watchAll=false
        else
          npm test
        fi

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v8
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore(${{ matrix.directory }}): update dependencies"
        title: "chore(${{ matrix.directory }}): update dependencies"
        body: |
          ## Dependency Updates for ${{ matrix.directory }}
          
          This PR contains automated dependency updates for the ${{ matrix.directory }} module.
          
          ### Changes
          - Updated patch and minor versions of dependencies
          - All tests are passing
          
          ### Review Checklist
          - [ ] Review updated dependencies for breaking changes
          - [ ] Verify all tests pass
          - [ ] Check for security vulnerabilities
          
          Auto-generated by GitHub Actions
        branch: dependency-updates/${{ matrix.directory }}
        delete-branch: true